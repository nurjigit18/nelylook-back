{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extrastyle %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css">
<style>
    .easy-creator-container {
        max-width: 1200px;
        margin: 20px auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }

    .section h2 {
        font-size: 20px;
        margin-bottom: 15px;
        color: #417690;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-group textarea {
        min-height: 80px;
        resize: vertical;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .color-variant {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 2px solid #dee2e6;
    }

    .color-variant.active {
        border-color: #417690;
    }

    .color-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .color-select {
        flex: 1;
        margin-right: 10px;
    }

    .btn-remove-color {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-remove-color:hover {
        background: #c82333;
    }

    .size-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }

    .size-item {
        border: 2px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        background: white;
        transition: all 0.2s;
    }

    .size-item.selected {
        border-color: #28a745;
        background: #d4edda;
    }

    .size-checkbox {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        cursor: pointer;
    }

    .size-checkbox input[type="checkbox"] {
        margin-right: 8px;
        width: auto;
    }

    .size-quantity input {
        width: 100%;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .btn-add-color {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 15px;
    }

    .btn-add-color:hover {
        background: #218838;
    }

    .btn-duplicate {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        margin-left: 10px;
    }

    .btn-duplicate:hover {
        background: #138496;
    }

    .upload-zone {
        border: 2px dashed #007bff;
        border-radius: 8px;
        background: #f8f9fa;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        min-height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .upload-zone:hover {
        background: #e9ecef;
        border-color: #0056b3;
    }

    .upload-zone .dz-message {
        margin: 0;
        font-size: 16px;
        color: #6c757d;
    }

    .dropzone .dz-preview {
        display: none;
    }

    .image-previews {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .image-preview-item {
        position: relative;
        border: 3px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }

    .image-preview-item img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }

    .image-color-badge {
        position: absolute;
        top: 5px;
        left: 5px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .color-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid white;
    }

    .upload-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: #e9ecef;
    }

    .upload-progress-bar {
        height: 100%;
        background: #28a745;
        transition: width 0.3s;
    }

    .uploading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #007bff;
    }

    .image-preview-item .remove-image {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
        font-weight: bold;
    }

    .image-preview-item .set-primary {
        position: absolute;
        bottom: 5px;
        left: 5px;
        background: #ffc107;
        color: black;
        border: none;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
    }

    .image-preview-item.primary {
        border-color: #ffc107;
        border-width: 3px;
    }

    .btn-submit {
        background: #417690;
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        margin-top: 20px;
    }

    .btn-submit:hover {
        background: #2e5266;
    }

    .btn-submit:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .alert-info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }

    .checkbox-group {
        display: flex;
        gap: 20px;
        margin-top: 10px;
    }

    .checkbox-group label {
        display: flex;
        align-items: center;
        font-weight: normal;
    }

    .checkbox-group input[type="checkbox"] {
        margin-right: 5px;
        width: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="easy-creator-container">
    <h1>üé® {{ title }}</h1>
    <p style="color: #666; margin-bottom: 30px;">–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ —Å –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏</p>

    <div id="alert-container"></div>

    <form id="easy-product-form">
        <!-- Basic Info -->
        <div class="section">
            <h2>üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="product_name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                    <input type="text" id="product_name" name="product_name" required>
                </div>
                <div class="form-group">
                    <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                    <select id="category" name="category" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        {% for category in categories %}
                        <option value="{{ category.category_id }}">{{ category.category_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="clothing_type">–¢–∏–ø –æ–¥–µ–∂–¥—ã</label>
                    <select id="clothing_type" name="clothing_type">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                        {% for type in clothing_types %}
                        <option value="{{ type.type_id }}">{{ type.type_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="short_description">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="short_description" name="short_description" rows="2"></textarea>
            </div>

            <div class="form-group">
                <label for="description">–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="description" name="description" rows="4"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="base_price">–¶–µ–Ω–∞ *</label>
                    <input type="number" id="base_price" name="base_price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="sale_price">–¶–µ–Ω–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π</label>
                    <input type="number" id="sale_price" name="sale_price" step="0.01">
                </div>
                <div class="form-group">
                    <label for="season">–°–µ–∑–æ–Ω</label>
                    <select id="season" name="season">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–∑–æ–Ω</option>
                        <option value="spring">–í–µ—Å–Ω–∞</option>
                        <option value="summer">–õ–µ—Ç–æ</option>
                        <option value="autumn">–û—Å–µ–Ω—å</option>
                        <option value="winter">–ó–∏–º–∞</option>
                        <option value="all_season">–í—Å–µ—Å–µ–∑–æ–Ω</option>
                    </select>
                </div>
            </div>

            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="is_featured" name="is_featured">
                    –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π
                </label>
                <label>
                    <input type="checkbox" id="is_new_arrival" name="is_new_arrival">
                    –ù–æ–≤–∏–Ω–∫–∞
                </label>
                <label>
                    <input type="checkbox" id="is_bestseller" name="is_bestseller">
                    –•–∏—Ç –ø—Ä–æ–¥–∞–∂
                </label>
            </div>
        </div>

        <!-- Colors & Sizes -->
        <div class="section">
            <h2>üé® –¶–≤–µ—Ç–∞ –∏ —Ä–∞–∑–º–µ—Ä—ã</h2>
            <button type="button" class="btn-add-color" onclick="addColorVariant()">+ –î–æ–±–∞–≤–∏—Ç—å —Ü–≤–µ—Ç</button>
            <div id="color-variants-container"></div>
        </div>

        <!-- Images -->
        <div class="section">
            <h2>üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–∞</h2>
            <div id="upload-status" style="display: none; background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                ‚è≥ <span id="upload-count">0</span> —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...
            </div>
            <p style="color: #666; margin-bottom: 15px;">
                –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤.
                –í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π —Ñ–æ—Ç–æ.
            </p>

            <div class="form-group">
                <label for="image_color">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –¥–ª—è –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–æ—Ç–æ</label>
                <select id="image_color" name="image_color">
                    <option value="">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ü–≤–µ—Ç –≤—ã—à–µ</option>
                </select>
            </div>

            <div id="dropzone-area" class="upload-zone">
                <div class="dz-message">
                    <strong>üì∑ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞</strong><br>
                    –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
                </div>
            </div>

            <div id="image-previews" class="image-previews"></div>
        </div>

        <!-- Submit -->
        <div class="section" style="border-bottom: none;">
            <button type="submit" class="btn-submit">‚ú® –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extrahead %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>
{% endblock %}

{% block footer %}
<script>
// Global state
const state = {
    colors: {{ colors_json|safe }},
    sizes: {{ sizes_json|safe }},
    colorVariants: [],
    images: [],
    nextVariantId: 1,
    uploadingCount: 0
};

// Prevent navigation during uploads
window.addEventListener('beforeunload', function(e) {
    if (state.uploadingCount > 0) {
        e.preventDefault();
        e.returnValue = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ—â–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è. –í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
        return e.returnValue;
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');

    // Check if Dropzone is available
    if (typeof Dropzone === 'undefined') {
        console.error('Dropzone library not loaded!');
        showAlert('error', '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        return;
    }

    // Add first color variant by default
    addColorVariant();

    // Initialize Dropzone
    initDropzone();
});

// Add color variant
function addColorVariant(duplicateFrom = null) {
    const variantId = state.nextVariantId++;
    const container = document.getElementById('color-variants-container');

    const variant = {
        id: variantId,
        colorId: duplicateFrom?.colorId || null,
        sizes: duplicateFrom?.sizes || []
    };

    state.colorVariants.push(variant);

    const variantHtml = `
        <div class="color-variant" data-variant-id="${variantId}">
            <div class="color-header">
                <select class="color-select" onchange="updateColorVariant(${variantId}, this.value)">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç</option>
                    {% for color in colors %}
                    <option value="{{ color.color_id }}" ${duplicateFrom?.colorId == {{ color.color_id }} ? 'selected' : ''}>
                        {{ color.color_name }}
                    </option>
                    {% endfor %}
                </select>
                <button type="button" class="btn-duplicate" onclick="duplicateColorVariant(${variantId})">
                    üìã –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button type="button" class="btn-remove-color" onclick="removeColorVariant(${variantId})">
                    ‚úï –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
            <div class="size-grid" id="size-grid-${variantId}">
                ${renderSizeGrid(variantId, duplicateFrom?.sizes)}
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', variantHtml);
    updateImageColorSelect();
}

// Render size grid
function renderSizeGrid(variantId, selectedSizes = []) {
    return state.sizes.map(size => {
        const selected = selectedSizes.find(s => s.sizeId == size.size_id);
        const quantity = selected?.quantity || 0;
        const isSelected = !!selected;

        return `
            <div class="size-item ${isSelected ? 'selected' : ''}" data-size-id="${size.size_id}">
                <div class="size-checkbox">
                    <input type="checkbox"
                           id="size-${variantId}-${size.size_id}"
                           ${isSelected ? 'checked' : ''}
                           onchange="toggleSize(${variantId}, ${size.size_id}, this.checked)">
                    <label for="size-${variantId}-${size.size_id}">${size.size_name}</label>
                </div>
                <div class="size-quantity">
                    <input type="number"
                           min="0"
                           value="${quantity}"
                           placeholder="–ö–æ–ª-–≤–æ"
                           ${!isSelected ? 'disabled' : ''}
                           onchange="updateSizeQuantity(${variantId}, ${size.size_id}, this.value)">
                </div>
            </div>
        `;
    }).join('');
}

// Toggle size selection
function toggleSize(variantId, sizeId, checked) {
    const variant = state.colorVariants.find(v => v.id === variantId);
    const sizeItem = document.querySelector(`[data-variant-id="${variantId}"] [data-size-id="${sizeId}"]`);
    const input = sizeItem.querySelector('input[type="number"]');

    if (checked) {
        sizeItem.classList.add('selected');
        input.disabled = false;
        input.focus();
        variant.sizes.push({ sizeId: sizeId, quantity: 0 });
    } else {
        sizeItem.classList.remove('selected');
        input.disabled = true;
        input.value = 0;
        variant.sizes = variant.sizes.filter(s => s.sizeId !== sizeId);
    }
}

// Update size quantity
function updateSizeQuantity(variantId, sizeId, quantity) {
    const variant = state.colorVariants.find(v => v.id === variantId);
    const size = variant.sizes.find(s => s.sizeId === sizeId);
    if (size) {
        size.quantity = parseInt(quantity) || 0;
    }
}

// Update color variant
function updateColorVariant(variantId, colorId) {
    const variant = state.colorVariants.find(v => v.id === variantId);
    variant.colorId = parseInt(colorId);
    updateImageColorSelect();
}

// Remove color variant
function removeColorVariant(variantId) {
    if (state.colorVariants.length === 1) {
        alert('–î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ü–≤–µ—Ç!');
        return;
    }

    state.colorVariants = state.colorVariants.filter(v => v.id !== variantId);
    document.querySelector(`[data-variant-id="${variantId}"]`).remove();
    updateImageColorSelect();
}

// Duplicate color variant
function duplicateColorVariant(variantId) {
    const variant = state.colorVariants.find(v => v.id === variantId);
    addColorVariant({
        colorId: null,
        sizes: variant.sizes.map(s => ({ ...s }))
    });
}

// Update image color select
function updateImageColorSelect() {
    const select = document.getElementById('image_color');

    const selectedColorIds = state.colorVariants
        .map(v => v.colorId)
        .filter(id => id !== null);

    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç</option>';

    selectedColorIds.forEach(colorId => {
        const color = state.colors.find(c => c.color_id === colorId);
        if (color) {
            const option = document.createElement('option');
            option.value = colorId;
            option.textContent = color.color_name;
            select.appendChild(option);
        }
    });
}

// Compress image before upload
function compressImage(file, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Max dimensions
            const MAX_WIDTH = 1200;
            const MAX_HEIGHT = 1200;

            if (width > height) {
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
            } else {
                if (height > MAX_HEIGHT) {
                    width *= MAX_HEIGHT / height;
                    height = MAX_HEIGHT;
                }
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob(function(blob) {
                callback(blob);
            }, 'image/jpeg', 0.85); // 85% quality
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// Initialize Dropzone
let dropzone;
function initDropzone() {
    try {
        // Disable auto-discovery
        Dropzone.autoDiscover = false;

        console.log('Initializing Dropzone...');

        const element = document.getElementById('dropzone-area');
        if (!element) {
            console.error('Dropzone element not found!');
            return;
        }

        dropzone = new Dropzone("#dropzone-area", {
            url: "/admin/catalog/product/easy-creator/upload/",
            paramName: "file",
            maxFilesize: 10, // MB
            acceptedFiles: "image/*",
            addRemoveLinks: false,
            clickable: true,
            parallelUploads: 2, // Upload 2 at a time
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            transformFile: function(file, done) {
                // Compress image before upload
                compressImage(file, done);
            },

            init: function() {
                console.log('Dropzone initialized!');

                this.on("addedfile", function(file) {
                    console.log('File added:', file.name);
                    const colorId = document.getElementById('image_color').value;

                    if (!colorId) {
                        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –¥–ª—è —Ñ–æ—Ç–æ!');
                        this.removeFile(file);
                        return;
                    }

                    state.uploadingCount++;
                    file._colorId = colorId; // Store color ID with file

                    // Add placeholder to preview immediately
                    const imageData = {
                        id: Date.now() + Math.random(),
                        colorId: parseInt(colorId),
                        url: null,
                        dataUrl: null,
                        isPrimary: state.images.length === 0,
                        uploading: true,
                        progress: 0,
                        fileName: file.name
                    };
                    state.images.push(imageData);
                    renderImagePreviews();
                });

                this.on("uploadprogress", function(file, progress) {
                    // Update progress
                    const imageData = state.images.find(img => img.fileName === file.name && img.uploading);
                    if (imageData) {
                        imageData.progress = progress;
                        renderImagePreviews();
                    }
                });

                this.on("success", function(file, response) {
                    console.log('Upload success:', response);
                    state.uploadingCount--;

                    if (response.success) {
                        // Find and update the image data
                        const imageData = state.images.find(img => img.fileName === file.name && img.uploading);
                        if (imageData) {
                            // Read file for preview
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                imageData.url = response.url;
                                imageData.dataUrl = e.target.result;
                                imageData.uploading = false;
                                imageData.progress = 100;
                                renderImagePreviews();
                            };
                            reader.readAsDataURL(file);
                        }
                    }

                    this.removeFile(file);
                });

                this.on("error", function(file, errorMessage) {
                    console.error('Upload error:', errorMessage);
                    state.uploadingCount--;

                    // Remove failed upload
                    state.images = state.images.filter(img => img.fileName !== file.name);
                    renderImagePreviews();

                    showAlert('error', `–û—à–∏–±–∫–∞: ${file.name}`);
                    this.removeFile(file);
                });
            }
        });

        console.log('Dropzone setup complete');
    } catch (error) {
        console.error('Error initializing Dropzone:', error);
        showAlert('error', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π');
    }
}

// Update upload status
function updateUploadStatus() {
    const statusDiv = document.getElementById('upload-status');
    const countSpan = document.getElementById('upload-count');

    if (state.uploadingCount > 0) {
        statusDiv.style.display = 'block';
        countSpan.textContent = state.uploadingCount;
    } else {
        statusDiv.style.display = 'none';
    }
}

// Render image previews
function renderImagePreviews() {
    const container = document.getElementById('image-previews');
    updateUploadStatus();

    container.innerHTML = state.images.map((img, index) => {
        const color = state.colors.find(c => c.color_id === img.colorId);

        if (img.uploading) {
            // Show uploading state
            return `
                <div class="image-preview-item" data-index="${index}">
                    <div style="width: 100%; height: 150px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                            <div style="font-size: 12px; color: #666;">${Math.round(img.progress)}%</div>
                        </div>
                    </div>
                    <div class="image-color-badge">
                        <div class="color-dot" style="background-color: ${color?.color_code || '#ccc'};"></div>
                        ${color?.color_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}
                    </div>
                    <div class="upload-progress">
                        <div class="upload-progress-bar" style="width: ${img.progress}%"></div>
                    </div>
                </div>
            `;
        }

        return `
            <div class="image-preview-item ${img.isPrimary ? 'primary' : ''}" data-index="${index}">
                <img src="${img.dataUrl}" alt="Preview">
                <div class="image-color-badge">
                    <div class="color-dot" style="background-color: ${color?.color_code || '#ccc'};"></div>
                    ${color?.color_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}
                </div>
                <button type="button" class="remove-image" onclick="removeImage(${index})">‚úï</button>
                <button type="button" class="set-primary" onclick="setPrimaryImage(${index})">
                    ${img.isPrimary ? '‚≠ê –ì–ª–∞–≤–Ω–æ–µ' : '–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω—ã–º'}
                </button>
            </div>
        `;
    }).join('');
}

// Remove image
function removeImage(index) {
    state.images.splice(index, 1);

    // If removed image was primary, make first image primary
    if (state.images.length > 0 && !state.images.some(img => img.isPrimary)) {
        state.images[0].isPrimary = true;
    }

    renderImagePreviews();
}

// Set primary image
function setPrimaryImage(index) {
    state.images.forEach((img, i) => {
        img.isPrimary = i === index;
    });
    renderImagePreviews();
}

// Form submission
document.getElementById('easy-product-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = document.querySelector('.btn-submit');
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞...';

    try {
        // Check if uploads are still in progress
        if (state.uploadingCount > 0) {
            throw new Error(`–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –µ—â–µ ${state.uploadingCount} —Ñ–æ—Ç–æ`);
        }

        // Validate
        if (state.colorVariants.length === 0) {
            throw new Error('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ü–≤–µ—Ç');
        }

        if (state.colorVariants.some(v => !v.colorId)) {
            throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –¥–ª—è –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤');
        }

        if (state.colorVariants.some(v => v.sizes.length === 0)) {
            throw new Error('–î–æ–±–∞–≤—å—Ç–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö —Ü–≤–µ—Ç–æ–≤');
        }

        // Prepare image data (already uploaded to Supabase)
        const imageData = prepareImageData();

        // Prepare data
        const formData = {
            product_name: document.getElementById('product_name').value,
            category_id: parseInt(document.getElementById('category').value),
            clothing_type_id: document.getElementById('clothing_type').value ? parseInt(document.getElementById('clothing_type').value) : null,
            description: document.getElementById('description').value,
            short_description: document.getElementById('short_description').value,
            base_price: parseFloat(document.getElementById('base_price').value),
            sale_price: document.getElementById('sale_price').value ? parseFloat(document.getElementById('sale_price').value) : null,
            season: document.getElementById('season').value,
            is_featured: document.getElementById('is_featured').checked,
            is_new_arrival: document.getElementById('is_new_arrival').checked,
            is_bestseller: document.getElementById('is_bestseller').checked,
            variants: state.colorVariants.map(v => ({
                color_id: v.colorId,
                sizes: v.sizes.map(s => ({
                    size_id: s.sizeId,
                    stock_quantity: s.quantity
                }))
            })),
            images: imageData
        };

        // Submit to backend
        const response = await fetch('/admin/catalog/product/easy-creator/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (result.success) {
            showAlert('success', result.message);
            setTimeout(() => {
                window.location.href = result.redirect_url;
            }, 1500);
        } else {
            throw new Error(result.error);
        }

    } catch (error) {
        showAlert('error', error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = '‚ú® –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä';
    }
});

// Images are already uploaded to Supabase via Dropzone
function prepareImageData() {
    return state.images
        .filter(img => !img.uploading && img.url) // Only uploaded images
        .map((img, index) => ({
            color_id: img.colorId,
            image_url: img.url, // Supabase URL from upload
            is_primary: img.isPrimary,
            display_order: index + 1
        }));
}

// Show alert
function showAlert(type, message) {
    const container = document.getElementById('alert-container');
    container.innerHTML = `
        <div class="alert alert-${type}">
            ${message}
        </div>
    `;

    setTimeout(() => {
        container.innerHTML = '';
    }, 5000);
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
